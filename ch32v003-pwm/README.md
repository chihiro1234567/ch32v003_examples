# CH32V003 Timer PWM

## How to build and execute

```bash
> make clean && make && ../ch32v003fun/minichlink/minichlink -T
:

```

## 基本的にSTM32に似ている

CH32VはかなりSTM32をリスペクトしているのか、仕様がかなり似ている。
CH32Vに関する情報が少なかったりリファレンスだけで分からない場合は、
STM32に関するサイトを見て理解を深めてから改めてリファレンスみると合点がいくことが多い。

タイマ・カウンタ【STM32の高機能・汎用タイマ詳細】
https://depfields.com/timer/


各比較キャプチャ・チャンネルは、

* 入力キャプチャ
* 出力キャプチャ
* PWM生成
* 単一パルス出力

などの複数の動作モードをサポートしている。

アドバンスド・コントロール・タイマーの複雑な機能の実装は、すべてタイマーの
* コンペア・キャプチャー・チャンネル
* クロック入力回路
* カウンタおよび周辺部品の動作
によって実現される。

### Input Capture Mode

ICxPS 信号の確定エッジが検出されるとキャプチャ・イベントが発生し、 
カウンタの現在値が比較キャプチャ・レジスタ（ TIMx_CHCTLRx ）に入力される。

キャプチャイベントが発生するとCCxIF（ Interrupt Status Register ( TIMx_INTFR ) ）がセットされ、
割り込みまたはDMAが有効になっていれば、対応する割り込みまたはDMAも生成されます。

1. ICx 信号のソースを選択するために CCxS （ TIMx_CHCTLRx ）ドメインを設定する。
例えば、10b に設定しCCxS ドメインはデフォルトで次のように設定する。
比較キャプチャモジュールを出力チャンネルにする。
2. ICxF （ TIMx_CHCTLRx ）ドメインを設定して、TI 信号のデジタル・フィルタを設定する。デジタル・フィルターは
信号を決められた周波数で決められた回数サンプリングし、ホップを出力する。このサンプリング周波数と回数は ICxF によって決定される。
3. CCxPビットでTIxFPxの極性を設定する。例えば、CC1PビットをLowにしておき
立ち上がりエッジジャンプを選択する。
4. ICxPS ドメインを構成し、ICx信号をICxPS間のクロスオーバー係数に設定する。例えば
例えば、ICxPSを00bに保ち、クロスオーバーしない。
5. CCxEビットを設定し、コア・カウンタ（CNT）の値をコンペアキャプチャレジスタに取り込む。
レジスタに取り込む。CC1E ビットを設定する。
6. CCxIEビットとCCxDEビットを必要に応じて設定し、割り込みやDMAを許可するかどうかを決定する。


### 出力比較モード
カウント数を0と自動リロードレジスタ（ARR:　Auto Reload Register）間に設定した
キャプチャコンペアレジスタ（CCR: Capture Compare Register）と比較するモードです。
カウント数がCCRと一致したときにタイマーの出力を変化させる。

例）汎用タイマの出力比較モードで5kHzのパルスを出力する

* タイマはTIM5の出力チャネルCH1～4のうちCH4(PA3)のみ使用する
* タイマへの供給クロックは36MHz
* カウンタの動作はカウントアップモードで出力比較モード

